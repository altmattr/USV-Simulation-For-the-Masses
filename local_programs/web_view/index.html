<html>
<meta charset="UTF-8">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/7.3.0/rxjs.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="./Controller.min.js"></script>
  <style>
    /* Always set the map height explicitly to define the size of the div
      * element that contains the map. */
    body {
      font-family:Arial, Helvetica, sans-serif;
    }
    #map {
      height: 400px;
      width: 400px;
    }

    .vis {
      display: inline-block;
    }

    ul {
      float:left;
    }
    </style>
</head>

<body>

<div id="map" class="vis">
    <script>
      var map;
      var marker;
      var goal;
      var sinks = {};
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -33.722, lng: 150.67398},
          zoom: 18,
          mapTypeId: "satellite",
        });
        marker = new google.maps.Marker({
          position: {lat: -33.722, lng:150.67398},
          map,
          title: "craft",
        });
        goal = new google.maps.Marker({
          position: {lat: -33.722, lng:150.67398},
          map,
          title: "goal",
        });
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDH2csoEoU0MN1xUvPrHK1MY2Gt4MfCFC8&callback=initMap"
    async defer></script>
</div>
<script>
sinks["/wamv/sensors/gps/gps/fix"] = (msg) => {
  latlng = {lat: msg.msg.latitude, lng: msg.msg.longitude}
  marker.setPosition(latlng);
}
sinks["/vrx/station_keeping/goal"] = (msg) => {
  latlng = {lat: msg.msg.pose.position.latitude, lng: msg.msg.pose.position.longitude}
  goal.setPosition(latlng);
}
</script>
<div class="vis">
  <p>GPS Velocity:<ul><li>x: <span id="gps_vel_x"></span></li><li>y: <span id="gps_vel_y"></span></li></ul>
                  <canvas id="gps_vis" width="100" height="100" style="border:1px solid grey"></canvas>
  </p>

  <script>
  sinks["/wamv/sensors/gps/gps/fix_velocity"] = (msg) => {
    var x = msg.msg.vector.x.toFixed(6);
    var y = msg.msg.vector.y.toFixed(6);
    document.getElementById("gps_vel_x").innerHTML = x;
    document.getElementById("gps_vel_y").innerHTML = y;
    var ctx = document.getElementById("gps_vis").getContext("2d");
    ctx.clearRect(0,0,100,100);
    ctx.beginPath();
    ctx.moveTo(50,50);
    ctx.lineTo(50+x*20, 50+y*20);
    ctx.stroke();
  }
  </script>

  <p>IMU:<ul><li>Direction (z-rotation): <span id="imu_direction"></span></li><li>Angular Velocity (z): <span id="imu_vel_z"></span></li></ul>
         <canvas id="imu_vis" width="100" height="100" style="border:1px solid grey"></canvas>
  </p>
  <script>
  sinks["/wamv/sensors/imu/imu/data"] = (msg) => {
    var eu = new THREE.Euler();
    var ex = new THREE.Quaternion(msg.msg.orientation.x, msg.msg.orientation.y, msg.msg.orientation.z, msg.msg.orientation.w);
    eu.setFromQuaternion(ex)
    document.getElementById("imu_direction").innerHTML = (eu.z).toFixed(6);
    document.getElementById("imu_vel_z").innerHTML = msg.msg.angular_velocity.x.toFixed(6);
    var ctx = document.getElementById("imu_vis").getContext("2d");
    ctx.clearRect(0,0,100,100);
    ctx.beginPath();
    ctx.moveTo(50,50);
    ctx.lineTo(50+Math.cos(eu.z)*45, 50-Math.sin(eu.z)*45);
    ctx.stroke();
  }
  </script>

  <p>Wind:<ul><li>Direction: <span id="wind_direction"></span></li><li>Speed: <span id="wind_speed"></span></li></ul>
    <canvas id="wind_vis" width="100" height="100" style="border:1px solid grey"></canvas>
  </p>
  <script>
  var dir;
  var speed;
  sinks["/vrx/debug/wind/direction"] = (msg) => {
    dir = msg.msg.data.toFixed(6);
    document.getElementById("wind_direction").innerHTML = dir;
  }
  sinks["/vrx/debug/wind/speed"] = (msg) => {
    speed = msg.msg.data.toFixed(6);
    document.getElementById("wind_speed").innerHTML = speed;
    var ctx = document.getElementById("wind_vis").getContext("2d");
    ctx.clearRect(0,0,100,100);
    ctx.beginPath();
    ctx.moveTo(50,50);
    console.log(speed);
    ctx.lineTo(50+Math.cos(dir*Math.PI/180)*speed*10, 50+Math.sin(dir*Math.PI/180)*speed*10);
    ctx.stroke();
  }
  </script>

  <p>Pose Error:<ul><li>Current: <span id="pose_error"></span></li><li>Mean: <span id="pose_error_mean"></span></li></ul></p>
  <script>
  sinks["/vrx/station_keeping/pose_error"] = (msg) => {
    document.getElementById("pose_error").innerHTML = msg.msg.data.toFixed(6);
  }
  sinks["/vrx/station_keeping/mean_pose_error"] = (msg) => {
    document.getElementById("pose_error_mean").innerHTML = msg.msg.data.toFixed(6);
  }
  </script>
</div>

<div class="vis">
  <p>
    <label>Thrusters</label><input id="thruster" type="range" name="points" min="-2" max="2" step="0.25"/><span id="thruster_val"></span>
    <script>
      // send thruster data every second
      setInterval(() => {
        var thrust = parseFloat(document.getElementById("thruster").value);
        console.log("trying to publish " + thrust);
        master.next({op: "publish", topic: "/wamv/thrusters/left_thrust_cmd", msg: {data: thrust}})
        master.next({op: "publish", topic: "/wamv/thrusters/right_thrust_cmd", msg: {data: thrust}})
        document.getElementById("thruster_val").innerHTML = thrust
      }, 1000)
    </script>
  </p>
  <p>
    <label>Rudders</label><input id="rudder" type="range" name="points" min="-1.5" max="1.5" step="0.1"/><span id="rudder_val"></span>
    <script>
      // send thruster @ 10 Hz
      setInterval(() => {
        var ang = parseFloat(document.getElementById("rudder").value)
        master.next({op: "publish", topic: "/wamv/thrusters/left_thrust_angle", msg: {data: ang}})
        master.next({op: "publish", topic: "/wamv/thrusters/right_thrust_angle", msg: {data: ang}})
        document.getElementById("rudder_val").innerHTML = ang
      }, 100)
    </script>
  </p>
</div>

<script>
  const { WebSocketSubject } = rxjs.webSocket;
  master = new WebSocketSubject("ws://localhost:9090");
  master.subscribe(
    msg => {
      sinks[msg.topic](msg);
    },
    err => console.log("ERROR: " + err),
    () => console.log("COMPLETE")
  );
  for(key in sinks){
    master.next({op: "subscribe", topic: key})
  };
</script>

<script>
// gamepad controls
Controller.search();
window.addEventListener("gc.analog.change", (evt) => {
  console.log(evt.detail);
   if (evt.detail.name === "LEFT_ANALOG_STICK"){
     document.getElementById("thruster").value = evt.detail.position.y*-2;
   }
   if (evt.detail.name === "RIGHT_ANALOG_STICK"){
     console.log(evt.detail.position.x);
     document.getElementById("rudder").value = evt.detail.position.x*1.5;
   }

});
window.addEventListener("keydown", (evt) => {
    console.log(evt.detail);
    if (evt.key === "w"){
      document.getElementById("thruster").value = 1;
    }
    if (evt.key === "s"){
      document.getElementById("thruster").value = -1;
    }
    if (evt.key === "a"){
      document.getElementById("rudder").value = -0.7;
    }
    if (evt.key === "d"){
      document.getElementById("rudder").value = 0.7;
    }
});
window.addEventListener("keyup", (evt) => {
    console.log(evt.detail);
    if (evt.key === "w"){
      document.getElementById("thruster").value = 0;
    }
    if (evt.key === "s"){
      document.getElementById("thruster").value = 0;
    }
    if (evt.key === "a"){
      document.getElementById("rudder").value = 0;
    }
    if (evt.key === "d"){
      document.getElementById("rudderaw").value = 0;
    }
});
</script>

</body>

</html>