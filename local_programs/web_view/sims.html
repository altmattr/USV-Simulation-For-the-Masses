<html>
<meta charset="UTF-8">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/7.3.0/rxjs.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.4.2.min.js"></script>
  <script src="./Controller.min.js"></script>
  <style>
    /* Always set the map height explicitly to define the size of the div
      * element that contains the map. */
    body {
      font-family:Arial, Helvetica, sans-serif;
    }
    #map {
      height: 400px;
      width: 400px;
    }

    .vis {
      display: inline-block;
    }

    ul {
      float:left;
    }
    </style>
</head>

<body>

<div id="map" class="vis">
    <script>
      var map;
      var marker;
      var goal;
      var sinks = {};
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -33.722, lng: 150.67398},
          zoom: 18,
          mapTypeId: "satellite",
        });
        marker = new google.maps.Marker({
          position: {lat: -33.722, lng:150.67398},
          map,
          title: "craft",
        });
        goal = new google.maps.Marker({
          position: {lat: -33.722, lng:150.67398},
          map,
          title: "goal",
        });
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDH2csoEoU0MN1xUvPrHK1MY2Gt4MfCFC8&callback=initMap"
    async defer></script>
</div>
<script>
sinks["/wamv/sensors/gps/gps/fix"] = (msg) => {
  latlng = {lat: msg.msg.latitude, lng: msg.msg.longitude}
  marker.setPosition(latlng);
}
sinks["/vrx/station_keeping/goal"] = (msg) => {
  latlng = {lat: msg.msg.pose.position.latitude, lng: msg.msg.pose.position.longitude}
  goal.setPosition(latlng);
}
</script>
<div class="vis">
  <p>GPS Velocity:<ul><li>x: <span id="gps_vel_x"></span></li><li>y: <span id="gps_vel_y"></span></li></ul>
                  <canvas id="gps_vis" width="100" height="100" style="border:1px solid grey"></canvas>
  </p>

  <script>
  sinks["/wamv/sensors/gps/gps/fix_velocity"] = (msg) => {
    var x = msg.msg.vector.x.toFixed(6);
    var y = msg.msg.vector.y.toFixed(6);
    document.getElementById("gps_vel_x").innerHTML = x;
    document.getElementById("gps_vel_y").innerHTML = y;
    var ctx = document.getElementById("gps_vis").getContext("2d");
    ctx.clearRect(0,0,100,100);
    ctx.beginPath();
    ctx.moveTo(50,50);
    ctx.lineTo(50+x*20, 50+y*20);
    ctx.stroke();
  }
  </script>

  <p>IMU:<ul><li>Direction (z-rotation): <span id="imu_direction"></span></li><li>Angular Velocity (z): <span id="imu_vel_z"></span></li></ul>
         <canvas id="imu_vis" width="100" height="100" style="border:1px solid grey"></canvas>
  </p>
  <script>
  sinks["/wamv/sensors/imu/imu/data"] = (msg) => {
    var eu = new THREE.Euler();
    var ex = new THREE.Quaternion(msg.msg.orientation.x, msg.msg.orientation.y, msg.msg.orientation.z, msg.msg.orientation.w);
    eu.setFromQuaternion(ex)
    document.getElementById("imu_direction").innerHTML = (eu.z).toFixed(6);
    document.getElementById("imu_vel_z").innerHTML = msg.msg.angular_velocity.x.toFixed(6);
    var ctx = document.getElementById("imu_vis").getContext("2d");
    ctx.clearRect(0,0,100,100);
    ctx.beginPath();
    ctx.moveTo(50,50);
    ctx.lineTo(50+Math.cos(eu.z)*45, 50-Math.sin(eu.z)*45);
    ctx.stroke();
  }
  </script>

  <p>Wind:<ul><li>Direction: <span id="wind_direction"></span></li><li>Speed: <span id="wind_speed"></span></li></ul>
    <canvas id="wind_vis" width="100" height="100" style="border:1px solid grey"></canvas>
  </p>
  <script>
  var dir;
  var speed;
  sinks["/vrx/debug/wind/direction"] = (msg) => {
    dir = msg.msg.data.toFixed(6);
    document.getElementById("wind_direction").innerHTML = dir;
  }
  sinks["/vrx/debug/wind/speed"] = (msg) => {
    speed = msg.msg.data.toFixed(6);
    document.getElementById("wind_speed").innerHTML = speed;
    var ctx = document.getElementById("wind_vis").getContext("2d");
    ctx.clearRect(0,0,100,100);
    ctx.beginPath();
    ctx.moveTo(50,50);
    ctx.lineTo(50+Math.cos(dir*Math.PI/180)*speed*10, 50+Math.sin(dir*Math.PI/180)*speed*10);
    ctx.stroke();
  }
  </script>

  <p>Pose Error:<ul><li>Current: <span id="pose_error"></span></li><li>Mean: <span id="pose_error_mean"></span></li></ul></p>
  <script>
  sinks["/vrx/station_keeping/pose_error"] = (msg) => {
    document.getElementById("pose_error").innerHTML = msg.msg.data.toFixed(6);
  }
  sinks["/vrx/station_keeping/mean_pose_error"] = (msg) => {
    document.getElementById("pose_error_mean").innerHTML = msg.msg.data.toFixed(6);
  }
  </script>
</div>

<div class="vis">
  <p>
    <label>Thrusters</label><input id="thruster" type="range" name="points" min="-2" max="2" step="0.25" oninput="publishThrust()"/><span id="thruster_val"></span>
    <script>
      // send thruster data every second
      function publishThrust(){
      console.log("thrust happened");
        var thrust = parseFloat(document.getElementById("thruster").value);
        master.next({op: "publish", topic: "/wamv/thrusters/left_thrust_cmd", msg: {data: thrust}})
        master.next({op: "publish", topic: "/wamv/thrusters/right_thrust_cmd", msg: {data: thrust}})
        document.getElementById("thruster_val").innerHTML = thrust
      }
    </script>
  </p>
  <p>
    <label>Rudders</label><input id="rudder" type="range" name="points" min="-1.5" max="1.5" step="0.1" oninput="publishRudder()"/><span id="rudder_val"></span>
    <script>
      function publishRudder(){
      console.log("rudder happened");
        var ang = parseFloat(document.getElementById("rudder").value)
        master.next({op: "publish", topic: "/wamv/thrusters/left_thrust_angle", msg: {data: ang}})
        master.next({op: "publish", topic: "/wamv/thrusters/right_thrust_angle", msg: {data: ang}})
        document.getElementById("rudder_val").innerHTML = ang
      }
    </script>
  </p>
</div>

<script>
  const { WebSocketSubject } = rxjs.webSocket;
  master = new WebSocketSubject("ws://localhost:9090");
  master.subscribe(
    msg => {
      sinks[msg.topic](msg);
    },
    err => console.log("ERROR: " + err),
    () => console.log("COMPLETE")
  );
  for(key in sinks){
    master.next({op: "subscribe", topic: key})
  };
</script>

<script>
// gamepad controls
Controller.search();
window.addEventListener("gc.analog.change", (evt) => {
  console.log(evt.detail);
   if (evt.detail.name === "LEFT_ANALOG_STICK"){
     document.getElementById("thruster").value = evt.detail.position.y*-2;
   }
   if (evt.detail.name === "RIGHT_ANALOG_STICK"){
     console.log(evt.detail.position.x);
     document.getElementById("rudder").value = evt.detail.position.x*1.5;
   }

});
window.addEventListener("keydown", (evt) => {
    console.log(evt.detail);
    if (evt.key === "w"){
      document.getElementById("thruster").value = 1;
    }
    if (evt.key === "s"){
      document.getElementById("thruster").value = -1;
    }
    if (evt.key === "a"){
      document.getElementById("rudder").value = -0.7;
    }
    if (evt.key === "d"){
      document.getElementById("rudder").value = 0.7;
    }
});
window.addEventListener("keyup", (evt) => {
    console.log(evt.detail);
    if (evt.key === "w"){
      document.getElementById("thruster").value = 0;
    }
    if (evt.key === "s"){
      document.getElementById("thruster").value = 0;
    }
    if (evt.key === "a"){
      document.getElementById("rudder").value = 0;
    }
    if (evt.key === "d"){
      document.getElementById("rudderaw").value = 0;
    }
});
</script>

<div id="status"></div>
<div id="rudd" style="width:800px;height:600px;"></div>
<div id="lat" style="width:800px;height:600px;"></div>
<div id="lng" style="width:800px;height:600px;"></div>
<script>
function getStats() {
  var stats = {lat: marker.getPosition().lat(), lng: marker.getPosition().lng(), ori: parseFloat(document.getElementById("imu_direction").innerHTML)};
  console.log(stats);
  return stats;
}

function deltaStats(start, end){
  var dlat = end.lat - start.lat;
  console.log(start.ori);
  var dlng = end.lng - start.lng;
  console.log(end.ori);
  return {lat: dlat*Math.cos(-1*start.ori) - dlng*Math.sin(-1*start.ori),
          lng: dlat*Math.sin(-1*start.ori) + dlng*Math.cos(-1*start.ori),
          ori: end.ori - start.ori};
}

var results=[]

function rudderSim(rudder){
    var trace1 = {
      x: results.map((x) => x.rudder),
      y: results.map((x) => x.ori),
      mode: "markers",
      type: "scatter"
    };
    Plotly.newPlot("rudd", [trace1], {title:"Orientation change due to rudder (1 sec thruster)"});
    var trace2 = {
      x: results.map((x) => x.rudder),
      y: results.map((x) => x.lat),
      mode: "markers",
      type: "scatter"
    };
    Plotly.newPlot("lat", [trace2], {title:"Latitude change due to rudder (1 sec thruster)"});
    var trace3 = {
      x: results.map((x) => x.rudder),
      y: results.map((x) => x.lng),
      mode: "markers",
      type: "scatter"
    }
    Plotly.newPlot("lng", [trace3], {title:"Longitutde change due to rudder (1 sec thruster)"})
  if (rudder >= Math.PI/2) {
    return;
  }
  document.getElementById("rudder").value = rudder; publishRudder();
  var startPos;
  setTimeout(() => {console.log("getting stats"); startPos = getStats();}, 500);
  setTimeout(() => {console.log("starting thrusters"); document.getElementById("thruster").value = 1; publishThrust();}, 1000);
  setTimeout(() => {console.log("stopping thrusters"); document.getElementById("thruster").value = 0; publishThrust();}, 2000);
  setTimeout(() => {
    console.log("recording results"); 
    var delta = deltaStats(startPos, getStats());
    delta.rudder = rudder;
    results.push(delta); 
    console.log(results);
    rudderSim(rudder+0.01)}, 20000);
}
function thrustSim(thrust){
    var trace1 = {
      x: results.map((x) => x.thrust),
      y: results.map((x) => x.ori),
      mode: "markers",
      type: "scatter"
    };
    Plotly.newPlot("rudd", [trace1], {title:"Orientation change due to thrust (0 rudder)"});
    var trace2 = {
      x: results.map((x) => x.thrust),
      y: results.map((x) => x.lat),
      mode: "markers",
      type: "scatter"
    };
    Plotly.newPlot("lat", [trace2], {title:"Latitude change due to rudder (0 rudder)"});
    var trace3 = {
      x: results.map((x) => x.thrust),
      y: results.map((x) => x.lng),
      mode: "markers",
      type: "scatter"
    }
    Plotly.newPlot("lng", [trace3], {title:"Longitutde change due to rudder (0 rudder)"})
  if (thrust >= 10000) {
    return;
  }
  document.getElementById("rudder").value = -0.01; publishRudder();
  var startPos;
  setTimeout(() => {console.log("getting stats"); startPos = getStats();}, 500);
  setTimeout(() => {console.log("starting thrusters"); document.getElementById("thruster").value = 1; publishThrust();}, 1000);
  setTimeout(() => {console.log("stopping thrusters"); document.getElementById("thruster").value = 0; publishThrust();}, 1000+thrust);
  setTimeout(() => {
    console.log("recording results"); 
    var delta = deltaStats(startPos, getStats());
    delta.thrust = thrust;
    results.push(delta); 
    thrustSim(thrust+1000)}, 20000);
}
thrustSim(1000);
//rudderSim(-0.2);

</script>
</body>

</html>