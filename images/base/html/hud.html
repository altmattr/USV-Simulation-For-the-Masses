<html>
<meta charset="UTF-8">
<head>
  <link rel="stylesheet" type="text/css" href="/style"/>
  <script src="https://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.13/ace.min.js" integrity="sha512-jB1NOQkR0yLnWmEZQTUW4REqirbskxoYNltZE+8KzXqs9gHG5mrxLR5w3TwUn6AylXkhZZWTPP894xcX/X8Kbg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.13/mode-javascript.min.js" integrity="sha512-37ta5K4KVYs+MEmIg2xnZxJrdiQmBSKt+JInvyPrq9uz7aF67lMJT/t91EYoYj520jEcGlih41kCce7BRTmE3Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <script src="./api.js"></script>
</head>

<body>
<div id="main-content">
  <nav>
    <a class="item" href="/">Team Boat</a>
    <a class="push item" href="/">Home</a>
    <a class="item" href="/hud">Simulation</a>
    <a class="item" href="https://github.com/osrf/vrx/blob/master/README.md">Documentation</a>
  </nav>
  
  <div id="control-panel">

    <!-- API.js Link -->
    <a class="hud-link" href="api.js">api.js</a>

    <!-- Share  -->
    <button class="hud-link" id="share">Share</button>
    <script>
      document.getElementById("share").onclick = function(){
      const program = editor.getValue();
      if(program === ""){
        swal({
          title: "No code to share :(",
          icon: "error"
        });
      } else {
        const encodedProgram = encodeURI(btoa(program));
        const error = encodedProgram.length > 2000 ? "Your program is over the recommended 2000 characters. This may lead to issues with your link. If this occurs, please decode the code variable within the link manually." : "";
        swal({
          title: "Share program",
          text: error,
          icon: error === "" ? "info" : "warning",
          buttons: {
            localhost: {
              text: "Localhost",
              value: "localhost"
            },
            macsim: {
              text: "MacSim",
              value: "macsim"
            }
          }
        }).then((value) => {
          switch(value){
            case "localhost":
              navigator.clipboard.writeText(`http://localhost/hud?code=${encodedProgram}`);
              swal("Copied to clipboard!", { icon: "success" });
              break;
            case "macsim":
              navigator.clipboard.writeText(`http://macsim.duckdns.org/hud?code=${encodedProgram}`);
              swal("Copied to clipboard!", { icon: "success" });
              break;
          }
        });
      }
    }
    </script>

    <!-- Start Simulation -->
    <button class="hud-link" id="sim-start">Start Simulation</button>
    <script>
      document.getElementById("sim-start").onclick = () => {
        if(craft.getTaskInfo().state !== "Not started"){
          swal({
            icon: "error",
            text: "A simulation is already running. Please wait until it has finished or stop it!"
          });
          document.getElementById("sim-start").setAttribute("disabled", "");
          document.getElementById("sim-stop").removeAttribute("disabled");
        } else {
          document.getElementById("sim-start").setAttribute("disabled", "");
          startSim("station_keeping").then(() => document.getElementById("sim-stop").removeAttribute("disabled"));
        }
      }
    </script>

    <!-- Stop Simulation -->
    <button class="hud-link" id="sim-stop">Stop Simulation</button>
    <script>
      document.getElementById("sim-stop").onclick = function(){
        if(craft.getTaskInfo().state === "Not started"){
          swal({
            icon: "error",
            text: "A simulation hasn't been started yet!"
          });
          document.getElementById("sim-stop").setAttribute("disabled", "");
          document.getElementById("sim-start").removeAttribute("disabled");
        } else {
          document.getElementById("sim-stop").setAttribute("disabled", "");
          stopSim().then(() => document.getElementById("sim-start").removeAttribute("disabled"));
        }
      };
    </script>

    <!-- Execute Editor Code -->
    <button class="push hud-link" id="execute">Execute</button>
    <script>
      document.getElementById("execute").onclick = function(){
        if(craft.getTaskInfo().state === "running"){
          try {
            eval(editor.getValue());
          } catch (error) {
            swal({ 
              icon: "error",
              title: "Error executing code.",
              text: error.message
            });
          }
        } else {
          swal({
            icon: "error",
            text: "A simulation isn't running or is starting up. Please wait until a simulation has started before executing code."
          });
        }
      }
    </script>

    
  </div>
  <div id="body-content">
  <!-- Google Maps Display -->
  <div id="map">
      <script>
        const icon = (rotation, colour, scale) => ({
          path: "M -12 5 L -12 -5 L 0 -5 L 0 -18 L 37 0 L 0 18 L 0 5 Z", 
          fillOpacity: 1,
          fillColor: colour,
          scale:0.5*scale, 
          rotation:(rotation/(Math.PI))*-180
        });
        
        const getAddress = () => {
          const url = window.location.href;
          const re = /https?:\/\/(.*)\/hud/;
          return re.exec(url)[1]
        }

        const polarToLatLng = ({ r, theta }) => ({
          lat: r * Math.sin(theta),
          lng: r * Math.cos(theta)
        });

        let craft = init(getAddress());
        var map;
        var marker;
        let simStarted = false;

        function initMap() {
          map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: -33.7224, lng: 150.67398},
            zoom: 18,
            disableDefaultUI: true,
            scaleControl: true,
            zoomControl: true,
            mapTypeId: "satellite",
          });
          marker = new google.maps.Marker({
            position: {lat: -33.722, lng:150.67398},
            icon: icon(Math.PI/2, "#FFFFFF", 1),
            map,
            title: "craft",
          });
          goal = new google.maps.Marker({
            position: {lat: 0, lng: 0},
            icon: icon(Math.PI/2, "#05FF05", 0.5),
            map,
            title: "goal",
          });
        }

        setInterval(() => {
          marker.setPosition(polarToLatLng(craft.getPosition()));
          marker.setIcon(icon(craft.getVelocity().theta, "#FFFFFF", 1));
          if(craft.getTaskInfo().name === "station_keeping" && craft.getGoalPosition() !== undefined && craft.getTaskInfo().state === "ready"){
            goal.setPosition(polarToLatLng(craft.getGoalPosition()));
            goal.setIcon(icon(craft.getGoalVelocity().theta, "#05FF05", 0.5));
          }
        }, 500);
      </script>
      <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDH2csoEoU0MN1xUvPrHK1MY2Gt4MfCFC8&callback=initMap"
      async defer></script>
  </div>
  
  <div id="info-panel">

    <!-- Text Editor  -->
    <div id="editor"></div>
    <script>
      var params = new URLSearchParams(window.location.search);
      if(params.has("ide") && params.get("ide") === "false"){
        document.getElementById("editor").setAttribute("show", "false");
        document.getElementById("editor-controls").style.display = "none";
      } else {
        var editor = ace.edit("editor"); 
        editor.session.setMode("ace/mode/javascript");
        // Base64 encoded demo
        if(params.has("code")){
          editor.setValue(atob(params.get("code")));
        }
      }
    </script>

    <!-- Console Log -->
    <div class="panel">
      <div id="console"></div>
      <!-- TY stackoverflow https://stackoverflow.com/questions/20256760/javascript-console-log-to-html -->
      <script>
          !function(o){ console.old = console.log,
                        console.log = function(){ 
                          var n, e, t ="";
                          for(e = 0; e < arguments.length; e++)
                          t += '<p id="console-log-body" class="log-' + typeof( n = arguments[e]) 
                            + '">', "object" == typeof n && "object" == typeof JSON && "function" == typeof JSON.stringify ? t 
                            += JSON.stringify(n): t += n, t;
                            o.innerHTML="<h3>Console Log</h3></p>"
                            + t, console.old.apply(void 0,arguments)}}
          (document.getElementById("console"));
      </script>
    </div>

    <!-- Camera Stream -->
    <div class="panel-half">

    <!-- Information Panel -->
    <div class="panel">
      <h3>Details</h3>
      <p id="state"></p>
      <script>
        setInterval(() => {
          document.getElementById("state").innerHTML = "<strong>Simulation Name</strong>: " + craft.getTaskInfo().name + "</p><strong>Simulation State</strong>: " + craft.getTaskInfo().state + "";
          if(craft.getTaskInfo().state == "ready"){
            document.getElementById("camera_stream").style.visibility = "visible";
            document.getElementById("camera_stream").src = "http://" + re.exec(window.location.href)[1] + ":8080/stream?topic=/wamv/sensors/cameras/front_left_camera/image_raw";
          }
        }, 500);
      </script>

    <!-- Time Remaining -->
      <p id="timer" ></p>
        <script>
          setInterval(() => {
            document.getElementById("timer").innerHTML = "<strong>Time remaining</strong>: " + craft.getTaskInfo().remaining_time+" <span style='font-size: 12px'>seconds</span>";
          }, 500);
        </script>

      <div id="error" ></div>
    </div>
    
      <!-- Camera Stream -->
      <img id="camera_stream" src="" style="visibility: hidden;";/>
      <script>
        const re = /https?:\/\/(.*)\/hud/;
        document.getElementById("camera_stream").src = "http://" + re.exec(window.location.href)[1] + ":8080/stream?topic=/wamv/sensors/cameras/front_left_camera/image_raw";

        //Check if simulation is ready, make camera visible and set source
        var cameraCheck = setInterval(() => {
          if(craft.getTaskInfo().state == "ready" || craft.getTaskInfo().state == "running"){
            document.getElementById("camera_stream").style.visibility = "visible";
            document.getElementById("camera_stream").src = "http://" + re.exec(window.location.href)[1] + ":8080/stream?topic=/wamv/sensors/cameras/front_left_camera/image_raw";
            clearInterval(cameraCheck);
          }
        }, 1000);
      </script>
    </div>
  </div>
  </div>
</div>
</body>
</html>