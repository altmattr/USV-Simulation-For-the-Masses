<html>
<meta charset="UTF-8">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/7.3.0/rxjs.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="./api.js"></script>
  <style>
    body {
      font-family:Arial, Helvetica, sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    #api {
      top: 10px;
      left: 100px;
      font-size: 25px;
      -webkit-text-fill-color: white;
      -webkit-text-stroke-width: 0.5px;
      -webkit-text-stroke-color: black;
    }
    #timer {
      top: 10px;
      right: 20px;
      font-size: 25px;
      -webkit-text-fill-color: white; 
      -webkit-text-stroke-width: 0.5px;
      -webkit-text-stroke-color: black;
    }
    #error {
      top: 50px;
      left: 10px;
      font-size: 60px;
      -webkit-text-fill-color: white;
      -webkit-text-stroke-width: 0.5px;
      -webkit-text-stroke-color: red;
    }
    #state {
      top: 10px;
      left: 300px;
      font-size: 25px;
      -webkit-text-fill-color: white;
      -webkit-text-stroke-width: 0.5px;
      -webkit-text-stroke-color: black; 
    }
    #start {
      top: 10px;
      left: 200px;
      font-size: 25px;
      -webkit-text-fill-color: white;
      -webkit-text-stroke-width: 0.5px;
      -webkit-text-stroke-color: black;
    }
    #stop {
      top: 10px;
      left: 250px;
      font-size: 25px;
      -webkit-text-fill-color: white;
      -webkit-text-stroke-width: 0.5px;
      -webkit-text-stroke-color: black;
    }
    a{
      text-decoration: none;
    }
    div {
      position: absolute
    }
    </style>
</head>

<body>

<div id="map">
    <script>
     function icon(rotation, colour, scale){
        return {path: "M -12 5 L -12 -5 L 0 -5 L 0 -18 L 37 0 L 0 18 L 0 5 Z", 
                fillOpacity: 1,
                fillColor: colour,
                scale:0.5*scale, 
                rotation:(rotation/(Math.PI))*-180
              }
      }
      
      function getWebSocketAddress(){
        const url = window.location.href;
        const re = /https?:\/\/(.*)\/hud/;
        return "ws://" + re.exec(url)[1] + ":9090"
      }

      const craft = init(getWebSocketAddress());
      var map;
      var marker;

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -33.7224, lng: 150.67398},
          zoom: 20,
          disableDefaultUI: true,
          scaleControl: true,
          zoomControl: true,
          mapTypeId: "satellite",
        });
        marker = new google.maps.Marker({
          position: {lat: -33.722, lng:150.67398},
          icon: icon(Math.PI/2, "#FFFFFF", 1),
          map,
          title: "craft",
        });
        goal = new google.maps.Marker({
          position: {lat: 0, lng: 0},
          icon: icon(Math.PI/2, "#05FF05", 0.5),
          map,
          title: "goal",
        });
      }

      setInterval(() => {
        marker.setPosition(craft.getPosition());
        marker.setIcon(icon(craft.getPosition().heading, "#FFFFFF", 1));
        if(craft.getTaskInfo().name === "station_keeping"){
          goal.setPosition(craft.getGoalPosition());
          goal.setIcon(icon(craft.getGoalPosition().heading, "#05FF05", 0.5));
        }
      }, 500);
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDH2csoEoU0MN1xUvPrHK1MY2Gt4MfCFC8&callback=initMap"
    async defer></script>
</div>
<div id="error"></div>
<svg id="hud" width = 100% height=100%></svg>
<div id="api"><a href="api.js">api.js</a></div>
<div id="state"></div>
<script>
  setInterval(() => {
    document.getElementById("state").innerHTML = "Name: " + craft.getTaskInfo().name + " State: " + craft.getTaskInfo().state;
  }, 500);
</script>
<div id="start">
  <button id="sim_start">Start</button>
  <script>
    document.getElementById("sim_start").onclick = () => {
      // Prevent any spam
      document.getElementById("sim_start").setAttribute("disabled", "");
      document.getElementById("sim_stop").setAttribute("disabled", "");
      startSim("station_keeping");
      setTimeout(() => window.location.reload(), 6000);
    }
  </script>
</div>
<div id="stop">
  <button id="sim_stop">Stop</button>
  <script>
    document.getElementById("sim_stop", onclick = () => {
      // Prevent any spam
      document.getElementById("sim_start").setAttribute("disabled", "");
      document.getElementById("sim_stop").setAttribute("disabled", "");
      stopSim();
      setTimeout(() => window.location.reload(), 5000);
    });
  </script>
</div>
<div id="timer"></div>
  <script>
    setInterval(() => {
      document.getElementById("timer").innerHTML = craft.getTaskInfo().remaining_time;
    }, 500);
  </script>
<img src="http://localhost:8080/stream?topic=/wamv/sensors/cameras/front_left_camera/image_raw" width=300 height=300 style="position: absolute; left: 20; bottom: 20;" onerror='this.style.display = "none"' />
</body>
</html>